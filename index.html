<!DOCTYPE html>
<html>
<head>
  <title>Scene 1 - Mileage vs. Price</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background: lightgrey;
      padding: 20px;
    }
    svg {
      background: white;
    }
  </style>
</head>

<body onload="init()">
  <h1 style="text-align: center; font-family: sans-serif; margin-bottom: 10px;">
    Exploring the Used Car Market: A Visual Story
  </h1>
  <h2 id="scene-title">Mileage vs. Price by Country of Origin</h2>
  <p id="scene-desc">Here we can see the relationship between mileage and price for used cars, categorized by country of origin. Each dot represents a vehicle, with color indicating its origin—American, Japanese, German, Korean, or Other. The scatterplot shows a clear downward trend: as mileage increases, price tends to decrease.</p>
  <button onclick="scene1()">Slide 1</button> 
  <button onclick="scene2()">Slide 2</button> 
  <button onclick="scene3()">Slide 3</button> <br>

  <svg width="750" height="450"></svg>
  
  <div id="filters" style="display:none; margin-bottom:10px;">
  <label for="origin">Origin:</label>
  <select id="origin">
    <option value="all">All</option>
  </select>

  <label for="year">Year:</label>
  <select id="year">
    <option value="all">All</option>
  </select>
  </div>
  <script>

  let data = [];
  async function init() {
    data = await d3.csv('https://Hash6325.github.io/US_cars_preprocessed.csv', d => {
      return {
        price: +d.price,
        mileage: +d.mileage,
        origin: d.country,
        brand: d.brand,
        model: d.model,
        year: +d.year
      };
    });
    scene1();
  }
  
    

  function scene1() {
    d3.select("svg").html("");
    document.getElementById("filters").style.display = "none";
    document.getElementById("scene-title").textContent = "Car Origin Distribution";
    document.getElementById("scene-desc").textContent = "This pie chart offers an overview of the distribution of used cars in the dataset used for this analysis, categorized by country of origin. Each slice represents a different origin group—American, Japanese, German, Korean, or Other—proportional to its presence in the dataset. It is clear that American car brands dominate this dataset and most of the remaining is made up of Japanese brands. A small percentage comes from Germany and Korea as well.";

    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const radius = 150

    const centerX = width / 2 - 50;
    const centerY = height / 2;

    const g = svg.append("g")
      .attr("transform", `translate(${centerX}, ${centerY})`);

    const color = d3.scaleOrdinal()
      .domain(["American", "Japanese", "German", "Korean", "Other country"])
      .range(["blue", "red", "green", "orange", "purple"]);

    const originCountsObj = data.reduce((acc, curr) => {
      acc[curr.origin] = (acc[curr.origin] || 0) + 1;
      return acc;
    }, {});
    const originCounts = Object.entries(originCountsObj).map(([origin, count]) => ({ origin, count }));

    const pie = d3.pie().value(d => d.count);
    const arc = d3.arc().innerRadius(0).outerRadius(radius);

    const data_ready = pie(originCounts);

    g.selectAll("path")
  .data(data_ready)
  .enter()
  .append("path")
  .attr("d", arc)
  .attr("fill", d => color(d.data.origin))
  .style("stroke-width", "2px")
  .on("mouseover", function(event, d) {
      const brands = data.filter(c => c.origin === d.data.origin);
      const total = brands.length;

      // Group by model
      const brandCounts = d3.rollup(brands, v => v.length, c => c.brand);
      const brandData = Array.from(brandCounts, ([brand, count]) => ({
        brand,
        percent: ((count / total) * 100).toFixed(1)
      }))
      // sort by % desc and keep top 5 for readability
      .sort((a,b) => d3.descending(+a.percent, +b.percent))
      .slice(0,5);

      // Build HTML for tooltip
      const html = `<strong>${d.data.origin}</strong><br>` +
                   brandData.map(b => `${b.brand}: ${b.percent}%`).join("<br>");

      d3.select("#tooltip")
        .style("display", "block")
        .html(html);
      
      d3.select(this).attr("stroke", "black").attr("stroke-width", 2);
  })
  .on("mousemove", function(event) {
      d3.select("#tooltip")
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
  })
  .on("mouseout", function() {
      d3.select("#tooltip").style("display", "none");
      d3.select(this).attr("stroke", null);
  });

    g.selectAll("text")
      .data(data_ready.filter(d => (d.data.count / data.length) > 0.02))
      .enter()
      .append("text")
      .text(d => `${((d.data.count / data.length) * 100).toFixed(1)}%`)
      .attr("transform", d => `translate(${arc.centroid(d)})`)
      .style("text-anchor", "middle")
      .style("fill", "white")
      .style("font-size", "11px");
      
    g.selectAll("line")
      .data(data_ready.filter(d => (d.data.count / data.length) <= 0.02 && (d.data.count / data.length) > 0.01))
      .enter()
      .append("line")
      .attr("x1", d => arc.centroid(d)[0])
      .attr("y1", d => arc.centroid(d)[1])
      .attr("x2", function(d,i){ return arc.centroid(d)[0] * 1.4 - i*15 - 15})
      .attr("y2", d => arc.centroid(d)[1] * 1.4 - 50)
      .attr("stroke", "black");

    g.selectAll("small-text")
      .data(data_ready.filter(d => (d.data.count / data.length) <= 0.02 && (d.data.count / data.length) > 0.01))
      .enter()
       
      .append("text")
      .text(d => `${((d.data.count / data.length) * 100).toFixed(1)}%`)
      .attr("x", function(d,i) {return arc.centroid(d)[0] * 1.5 - i*15 - 15;})
      .attr("y", d => arc.centroid(d)[1] * 1.5 - 50)
      .style("font-size", "10px")
      .style("text-anchor", "middle");
    const legend = svg.append("g")
      .attr("transform", `translate(${width - 160}, 60)`);

    originCounts.forEach((d, i) => {
      const row = legend.append("g")
        .attr("transform", `translate(0, ${i * 20})`);

      row.append("rect")
        .attr("width", 12)
        .attr("height", 12)
       
        .attr("fill", color(d.origin))
        ;

      row.append("text")
        .attr("x", 18)
        .attr("y", 10)
        .text(d.origin);
    });
  }


function scene2(){
  d3.select("svg").html("");
  document.getElementById("filters").style.display = "none";
  document.getElementById("scene-title").textContent = "Mileage vs. Price by Country of Origin";
  document.getElementById("scene-desc").textContent = "Here we can see the relationship between mileage and price for used cars, categorized by country of origin. Each dot represents a vehicle, with color indicating its origin—American, Japanese, German, Korean, or Other. The scatterplot shows a clear downward trend: as mileage increases, price tends to decrease.";

  const svg = d3.select("svg");
  const margin = {top: 40, right: 140, bottom: 60, left: 70};
  const width = +svg.attr("width") - margin.left - margin.right;
  const height = +svg.attr("height") - margin.top - margin.bottom;

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const x = d3.scaleLinear().domain([0, 250000]).range([0, width]);
  const y = d3.scaleLinear().domain([0, d3.max(data, d => d.price)]).range([height, 0]);

  const color = d3.scaleOrdinal()
    .domain(["American", "Japanese", "German", "Korean", "Other country"])
    .range(["blue", "red", "green", "orange", "purple"]);

  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x));

  g.append("g").call(d3.axisLeft(y));

  g.append("text")
    .attr("x", width / 2)
    .attr("y", height + 40)
    .attr("text-anchor", "middle")
    .text("Mileage");

  g.append("text")
    .attr("transform", "rotate(-90)")
    .attr("x", -height / 2)
    .attr("y", -50)
    .attr("text-anchor", "middle")
    .text("Price (USD)");

  const tooltip = d3.select("#tooltip");

  const circles = g.selectAll("circle")
    .data(data.filter(d => d.price > 0 && d.mileage > 0 && d.mileage < 250000),
          d => d.brand + d.model + d.year);

  circles.join(
    enter => enter.append("circle")
                  .attr("cx", d => x(d.mileage))
                  .attr("cy", d => y(d.price))
                  .attr("r", 2)
                  .attr("fill", d => color(d.origin))
                  .attr("opacity", 0)
                  .on("mouseover", function(event, d) {
                    tooltip.style("display", "block")
                           .html(`<strong>${d.year} ${d.brand} ${d.model}</strong><br>Mileage: ${d.mileage}<br>Price: $${d.price}`);
                    d3.select(this).attr("r", 4).attr("stroke", "#000");
                  })
                  .on("mousemove", function(event) {
                    tooltip.style("left", (event.pageX + 10) + "px")
                           .style("top", (event.pageY - 28) + "px");
                  })
                  .on("mouseout", function() {
                    tooltip.style("display", "none");
                    d3.select(this).attr("r", 2).attr("stroke", null);
                  })
                  .transition().duration(800)
                  .attr("opacity", 0.4),
    update => update.transition().duration(800)
                    .attr("cx", d => x(d.mileage))
                    .attr("cy", d => y(d.price)),
    exit => exit.transition().duration(800)
                .attr("opacity", 0)
                .remove()
  );

 
    //American
    g.append("line")
     
      .attr("x1", x(0))
      .attr("y1", y(27377))
      .attr("x2", x(194126))
      .attr("y2", y(0))
      .style("stroke", "blue")
      .style("stroke-width", 3);
    //Japanese
    g.append("line")
      .attr("x1", x(0))
      .attr("y1", y(16021))
      .attr("x2", x(182955))
      .attr("y2", y(0))
      .style("stroke", "red")
      .style("stroke-width", 3);
    //German
    g.append("line")
      .attr("x1", x(0))
      .attr("y1", y(42611))
      .attr("x2", x(118163))
      .attr("y2", y(0))
      .style("stroke", "green")
      .style("stroke-width", 3);
    //Korean
    g.append("line")
      .attr("x1", x(0))
      .attr("y1", y(10176))
      .attr("x2", x(280896))
      .attr("y2", y(0))
      .style("stroke", "orange")
      .style("stroke-width", 3); 
      

  const legend = g.append("g")
    .attr("transform", `translate(${width - 100}, 0)`);

  color.domain().forEach((origin, i) => {
    const row = legend.append("g")
      .attr("transform", `translate(0, ${i * 20})`);

    row.append("rect")
      .attr("width", 12)
      .attr("height", 12)
      .attr("fill", color(origin));

    row.append("text")
      .attr("x", 18)
      .attr("y", 10)
      .text(origin);
  });
}
function scene3(){

    d3.select("svg").html("");
    document.getElementById("scene-title").textContent = "Average Price by Brand";
    document.getElementById("scene-desc").textContent = "In this scene, you're looking at a bar chart that shows the average price of used cars for each brand in the dataset. Each bar is colored based on the car's country of origin, just like in the previous scenes. You can use the dropdown filters to focus on a specific origin or production year if you want to narrow things down. This view gives you a clearer idea of how car brands compare in terms of pricing, and how factors like origin or year might affect those averages.";
    document.getElementById("filters").style.display = "none";
    document.getElementById("filters").style.display = "block";
    const svg = d3.select("svg");
    const margin = 50;
    const width = +svg.attr("width") - 2*margin;
    const height = +svg.attr("height") - 2*margin;

    const chartGroup = svg.append("g")
                          .attr("transform", "translate("+margin+","+margin+")");

    const x = d3.scaleBand().range([0, width]).padding(0.2);
    const y = d3.scaleLinear().range([height, 0]);

    const xAxisGroup = chartGroup.append("g")
                                 .attr("transform", "translate(0,"+height+")");
    const yAxisGroup = chartGroup.append("g");

    // Populate filters only once (if not already)
    const originSelect = document.getElementById("origin");
    const yearSelect = document.getElementById("year");

    // Clear existing filter options except "All"
    originSelect.length = 1;
    yearSelect.length = 1;

    const origins = Array.from(new Set(data.map(d => d.origin)));
    origins.forEach(o => {
      originSelect.insertAdjacentHTML("beforeend", `<option value="${o}">${o}</option>`);
    });

    const years = Array.from(new Set(data.map(d => d.year))).sort();
    years.forEach(y => {
      yearSelect.insertAdjacentHTML("beforeend", `<option value="${y}">${y}</option>`);
    });

function updateChart(filteredData) {
  // Group by brand
  const grouped = d3.groups(filteredData, d => d.brand)
                    .map(([brand, cars]) => ({
                      brand,
                      avgPrice: d3.mean(cars, c => c.price),
                      origin: cars[0].origin  // <--- save origin
                    }));

  // Update scales
  x.domain(grouped.map(d => d.brand));
  y.domain([0, d3.max(grouped, d => d.avgPrice)]).nice();

  // Update axes
  xAxisGroup.transition().duration(750)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "rotate(-30)");

  yAxisGroup.transition().duration(750)
            .call(d3.axisLeft(y));

  // Color scale (same as Scene 1 & 3)
  const color = d3.scaleOrdinal()
    .domain(["American", "Japanese", "German", "Korean", "Other country"])
    .range(["blue", "red", "green", "orange", "purple"]);

  // Bind data
  const bars = chartGroup.selectAll(".bar").data(grouped, d => d.brand);

  // Exit
  bars.exit()
      .transition().duration(750)
      .attr("y", height)
      .attr("height", 0)
      .remove();

  // Update
  bars.transition().duration(750)
      .attr("x", d => x(d.brand))
      .attr("y", d => y(d.avgPrice))
      .attr("width", x.bandwidth())
      .attr("height", d => height - y(d.avgPrice))
      .attr("fill", d => color(d.origin));   // <--- add color

  // Enter
  bars.enter().append("rect")
      .attr("class", "bar")
      .attr("x", d => x(d.brand))
      .attr("y", height)
      .attr("width", x.bandwidth())
      .attr("height", 0)
      .attr("fill", d => color(d.origin))   // <--- add color
      .transition().duration(750)
      .attr("y", d => y(d.avgPrice))
      .attr("height", d => height - y(d.avgPrice));
}

    function applyFilters() {
      const selectedOrigin = originSelect.value;
      const selectedYear = yearSelect.value;

      let filtered = data;
      if (selectedOrigin !== "all") {
        filtered = filtered.filter(d => d.origin === selectedOrigin);
      }
      if (selectedYear !== "all") {
        filtered = filtered.filter(d => d.year === +selectedYear);
      }
      updateChart(filtered);
    }

    originSelect.addEventListener("change", applyFilters);
    yearSelect.addEventListener("change", applyFilters);

    // Initial chart
    updateChart(data);
  }
  </script>
<div id="tooltip" style="position:absolute; padding:6px; font-size:12px; background:white; border:1px solid #999; border-radius:4px; pointer-events:none; display:none;"></div>

</body>
</html>
